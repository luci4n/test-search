<div class="search-container">
  <!-- Main Search Input -->
  <div class="search-input-wrapper" [class.has-results]="showDropdown">
    <div class="input-group">
      <!-- Search Icon -->
      <span class="search-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path
            d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM19 19l-4.35-4.35"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
      </span>

      <!-- Input Field -->
      <input
        #searchInput
        type="text"
        class="search-input"
        [value]="searchTerm"
        (input)="onSearchInput($event)"
        (focus)="onFocus()"
        (blur)="onBlur()"
        (keydown)="onKeyDown($event)"
        [placeholder]="placeholder"
        [disabled]="isDisabled"
        [attr.aria-label]="'Search fruits'"
        [attr.aria-expanded]="showDropdown"
        [attr.aria-controls]="'search-results'"
        [attr.aria-activedescendant]="selectedIndex >= 0 ? 'result-' + selectedIndex : null"
        aria-autocomplete="list"
        role="combobox"
        autocomplete="off"
        spellcheck="false"
      />

      <!-- Loading Spinner -->
      @if(isLoading) {
      <span class="loading-spinner">
        <svg class="spinner" width="20" height="20" viewBox="0 0 20 20">
          <circle
            cx="10"
            cy="10"
            r="8"
            stroke="currentColor"
            stroke-width="2"
            fill="none"
            stroke-dasharray="50"
            stroke-dashoffset="0"
          ></circle>
        </svg>
      </span>
      }

      <!-- Clear Button -->
      @if(searchTerm && !isLoading) {
      <button
        class="clear-button"
        (click)="clearSearch()"
        type="button"
        aria-label="Clear search"
        tabindex="-1"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path
            d="M12 4L4 12M4 4l8 8"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
      </button>
      }
    </div>

    <!-- Dropdown Results -->
    @if(showDropdown) {
    <div
      class="search-dropdown"
      id="search-results"
      role="listbox"
      [attr.aria-label]="'Search results'"
    >
      <!-- Loading State -->
      @if(isLoading && !hasResults) {
      <div class="dropdown-state loading-state">
        <svg class="spinner-large" width="32" height="32" viewBox="0 0 32 32">
          <circle
            cx="16"
            cy="16"
            r="12"
            stroke="currentColor"
            stroke-width="3"
            fill="none"
            stroke-dasharray="75"
            stroke-dashoffset="0"
          ></circle>
        </svg>
        <p>Searching...</p>
      </div>

      } @if(hasError && !isLoading) {
      <!-- Error State -->
      <div class="dropdown-state error-state">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" />
          <path
            d="M16 10v8M16 22v2"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
        <p class="error-message">{{ errorMessage }}</p>
        <button class="retry-button" (click)="retry()" type="button">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path
              d="M14 8A6 6 0 1 0 4 4.5M4 1v3.5h3.5"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          Retry
        </button>
      </div>

      }

      <!-- No Results State -->
      @if(!hasResults && !isLoading && !hasError && hasSearched) {
      <div class="dropdown-state no-results-state">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" />
          <path
            d="M10 18c0-2 2-3 6-3s6 1 6 3M12 12h.01M20 12h.01"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
        <p>No fruits found for "{{ searchTerm }}"</p>
        <p class="hint">Try searching for: apple, banana, cherry...</p>
      </div>
      } @if(!hasSearched && !searchTerm) {<!-- Empty State (before search) -->
      <div class="dropdown-state empty-state">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
          <path
            d="M14 28a12 12 0 1 0 0-24 12 12 0 0 0 0 24zM28 28l-6.5-6.5"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
          />
        </svg>
        <p>Start typing to search fruits</p>
        <div class="suggestions">
          <span class="suggestion-label">Popular:</span>
          @for (fruit of popularFruits; track fruit) {
          <button class="suggestion-chip" (click)="selectSuggestion(fruit)" type="button">
            {{ fruit }}
          </button>
          }
        </div>
      </div>
      } @if(hasResults && !isLoading) {
      <ul class="results-list">
        @for (result of results; track result; let i = $index) {
        <li
          [id]="'result-' + i"
          class="result-item"
          [class.selected]="i === selectedIndex"
          [class.highlighted]="i === selectedIndex"
          (click)="selectResult(result)"
          (mouseenter)="selectedIndex = i"
          role="option"
          [attr.aria-selected]="i === selectedIndex"
        >
          <svg class="result-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" />
            <path d="M8 5v6M5 8h6" stroke="currentColor" stroke-width="1.5" />
          </svg>
          <span class="result-text" [innerHTML]="highlightMatch(result, searchTerm)"></span>
          @if (i === selectedIndex) {
          <svg class="check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path
              d="M3 8l3 3 7-7"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>

          }
        </li>
        }
      </ul>
      } @if(hasResults && !isLoading) {
      <!-- Results Footer (with count and latency info) -->
      <div class="results-footer">
        <span class="results-count">
          {{ results.length }} {{ results.length === 1 ? 'result' : 'results' }}
        </span>
        @if (latency) {
        <span class="latency">{{ latency }}ms</span>
        }
      </div>
      }
    </div>
    }
  </div>

  @if(selectedValue) {
  <!-- Selected Value Display (optional) -->
  <div class="selected-value">
    <span class="selected-label">Selected:</span>
    <span class="selected-text">{{ selectedValue }}</span>
    <button
      class="remove-selection"
      (click)="removeSelection()"
      type="button"
      aria-label="Remove selection"
    >
      ×
    </button>
  </div>
  } @if(showErrorToast) {
  <!-- Error Toast (for persistent errors) -->
  <div class="error-toast" [@slideIn]>
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
      <circle cx="10" cy="10" r="9" fill="currentColor" opacity="0.1" />
      <path d="M10 6v5M10 14v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
    </svg>
    <span>{{ toastMessage }}</span>
    <button (click)="dismissToast()" type="button" aria-label="Dismiss">×</button>
  </div>
  } @if(showDebugInfo) {
  <!-- Debounce Indicator (for debugging) -->
  <div class="debug-info">
    <small>
      Debounce: {{ debounceTime }}ms | Requests: {{ requestCount }} | Errors: {{ errorCount }}
    </small>
  </div>
  }
</div>
